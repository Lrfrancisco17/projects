---
- name: CIS password, PAM, and kernel hardening
  hosts: all
  become: true
  gather_facts: false

  vars:
    cis_pass_max_days: 365
    cis_pass_warn_age: 7
    cis_inactive_days: 30
    cis_password_history: 24

  tasks:

  ###########################################################################
  # 4.5.1.2 / 4.5.1.3 — PASS_MAX_DAYS / PASS_WARN_AGE
  ###########################################################################

    - name: Ensure PASS_MAX_DAYS is set
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^\s*PASS_MAX_DAYS'
        line: "PASS_MAX_DAYS {{ cis_pass_max_days }}"
        create: yes
        backup: true

    - name: Ensure PASS_WARN_AGE is set
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^\s*PASS_WARN_AGE'
        line: "PASS_WARN_AGE {{ cis_pass_warn_age }}"
        create: yes
        backup: true

    - name: Apply password aging to existing human users
      ansible.builtin.shell: |
        awk -F: '($2 !~ /^[!*]/) && ($3 >= 1000) && ($1 != "nfsnobody") {print $1}' /etc/shadow | \
        while read u; do
          chage --maxdays {{ cis_pass_max_days }} --warndays {{ cis_pass_warn_age }} "$u"
        done
      args:
        executable: /bin/bash
      register: chage_out
      changed_when: chage_out.rc == 0


  ###########################################################################
  # 4.5.1.4 — INACTIVE password lock
  ###########################################################################

    - name: Set default INACTIVE to 30 days
      ansible.builtin.command: useradd -D -f {{ cis_inactive_days }}
      register: useradd_default
      changed_when: "'INACTIVE={{ cis_inactive_days }}' not in useradd_default.stdout"

    - name: Apply INACTIVE to existing human users
      ansible.builtin.shell: |
        awk -F: '($2 !~ /^[!*]/) && ($3 >= 1000) && ($1 != "nfsnobody") {print $1}' /etc/shadow | \
        while read u; do
          chage --inactive {{ cis_inactive_days }} "$u"
        done
      args:
        executable: /bin/bash
      register: inactive_out
      changed_when: inactive_out.rc == 0


  ###########################################################################
  # 4.4.3.2.x — pwquality settings
  ###########################################################################

    - name: Ensure pwquality directory exists
      ansible.builtin.file:
        path: /etc/security/pwquality.conf.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Configure pwquality settings
      ansible.builtin.copy:
        dest: /etc/security/pwquality.conf.d/50-pwquality.conf
        content: |
          difok = 2
          maxsequence = 3
        owner: root
        group: root
        mode: '0644'
        backup: true


  ###########################################################################
  # 4.4.3.3.1 — Password history (pam_pwhistory)
  ###########################################################################

    - name: Ensure pwhistory.conf contains remember and enforce_for_root
      ansible.builtin.blockinfile:
        path: /etc/security/pwhistory.conf
        create: yes
        backup: true
        block: |
          remember = {{ cis_password_history }}
          enforce_for_root

    - name: Get authselect profile name
      ansible.builtin.command: awk 'NR==1 {print $1}' /etc/authselect/authselect.conf
      register: authselect_profile
      changed_when: false

    - name: Set authselect PAM directory
      ansible.builtin.set_fact:
        authselect_pam_dir: "/etc/authselect/{{ authselect_profile.stdout }}"

    - name: Remove remember= from pam_pwhistory in authselect profile
      ansible.builtin.replace:
        path: "{{ authselect_pam_dir }}/{{ item }}"
        regexp: '(^\s*password\s+(requisite|required|sufficient)\s+pam_pwhistory\.so.*)\s+remember=\S+'
        replace: '\1'
        backup: true
      loop:
        - system-auth
        - password-auth

    - name: Apply authselect changes
      ansible.builtin.command: authselect apply-changes
      changed_when: true


  ###########################################################################
  # 4.4.3.4.2 — Remove remember= from pam_unix
  ###########################################################################

    - name: Remove remember= from pam_unix in authselect profile
      ansible.builtin.replace:
        path: "{{ authselect_pam_dir }}/{{ item }}"
        regexp: 'remember=\S+'
        replace: ''
        backup: true
      loop:
        - system-auth
        - password-auth


  ###########################################################################
  # 1.4.2 — Kernel ptrace_scope
  ###########################################################################

    - name: Persist ptrace_scope
      ansible.builtin.copy:
        dest: /etc/sysctl.d/60-kernel_sysctl.conf
        content: "kernel.yama.ptrace_scope = 1\n"
        owner: root
        group: root
        mode: '0644'
        backup: true

    - name: Apply ptrace_scope at runtime
      ansible.builtin.command: sysctl -w kernel.yama.ptrace_scope=1
      changed_when: false

