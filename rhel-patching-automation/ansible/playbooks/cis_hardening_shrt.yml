---
- name: CIS password, PAM, and kernel hardening
  hosts: all
  become: true
  gather_facts: false

  vars:
    cis_pass_max_days: 365
    cis_pass_min_days: 0
    cis_pass_warn_age: 7
    cis_inactive_days: 30
    cis_password_history: 24

  tasks:

  ###########################################################################
  # 4.5.1.2 / 4.5.1.3 — PASS_MAX_DAYS / PASS_WARN_AGE
  ###########################################################################

    - name: Ensure PASS_MAX_DAYS is set
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^\s*PASS_MAX_DAYS'
        line: "PASS_MAX_DAYS {{ cis_pass_max_days }}"
        create: yes
        backup: true

    ###########################################################################
    # System accounts (UID 1–999) with real passwords
    ###########################################################################

    - name: Get system accounts (UID 0–999)
      ansible.builtin.command: >
        awk -F: '($3 <= 999 && $3 >= 0) {print $1}' /etc/passwd
      register: system_accounts_raw
      changed_when: false

    - name: Set system accounts fact
      ansible.builtin.set_fact:
        system_accounts: "{{ system_accounts_raw.stdout_lines }}"

    - name: Apply CIS password aging to system accounts
      ansible.builtin.user:
        name: "{{ item }}"
        password_expire_max: "{{ cis_pass_max_days }}"
        password_expire_min: "{{ cis_pass_min_days }}"
        password_expire_warn: "{{ cis_pass_warn_age }}"
      loop: "{{ system_accounts }}"

    - name: Set INACTIVE days for system accounts
      ansible.builtin.command: >
        chage --inactive {{ cis_inactive_days }} {{ item }}
      loop: "{{ system_accounts }}"
      changed_when: true

    ###########################################################################
    # Human accounts (UID >= 1000)
    ###########################################################################

    - name: Get human users
      ansible.builtin.command: >
        awk -F: '($3 >= 1000) && ($1 != "nfsnobody") {print $1}' /etc/passwd
      register: human_accounts_raw
      changed_when: false

    - name: Set human accounts fact
      ansible.builtin.set_fact:
        human_accounts: "{{ human_accounts_raw.stdout_lines }}"

    - name: Apply CIS password aging to human accounts
      ansible.builtin.user:
        name: "{{ item }}"
        password_expire_max: "{{ cis_pass_max_days }}"
        password_expire_min: "{{ cis_pass_min_days }}"
        password_expire_warn: "{{ cis_pass_warn_age }}"
      loop: "{{ human_accounts }}"

    - name: Set INACTIVE days for human accounts
      ansible.builtin.command: >
        chage --inactive {{ cis_inactive_days }} {{ item }}
      loop: "{{ human_accounts }}"
      changed_when: true
